# 実装状況サマリー

## 実装完了日
2024年（最新更新）

## 実装済み機能

### 1. ファイルアップロード機能 ✅
- **場所**: `front/components/FileUploadForm.tsx`
- **機能**: CSVファイルのアップロードとパース
- **対応文字コード**: UTF-8 (BOM付き含む), Shift-JIS (CP932)
- **バックエンド**: `api/app/routes/checks.py` - `POST /checks/upload`

### 2. 法人番号一括照合機能 ✅
- **場所**: 
  - フロントエンド: `front/components/FileUploadForm.tsx` - `handleBulkLookup`
  - バックエンド: `api/app/services/corporate_lookup.py` - `CorporateLookupService`
- **機能**: 
  - 国税庁法人番号 Web-API との連携
  - レート制限対策（リクエスト間隔制御）
  - リトライ機能（最大3回）
  - エラーハンドリング
- **バックエンドAPI**: `POST /checks/bulk-lookup`

### 3. 照合結果表示機能 ✅
- **場所**: `front/components/FileUploadForm.tsx`
- **機能**: 
  - 照合ステータスのバッジ表示
  - ステータス種類: 一致、要確認、未登録、エラー、未照合、照合中
  - テーブル形式での一覧表示

### 4. CSVダウンロード機能 ✅
- **場所**: `front/components/FileUploadForm.tsx` - `handleDownloadCSV`
- **機能**: 
  - 照合結果をCSV形式でダウンロード
  - BOM付きUTF-8エンコード（Excel対応）
  - タイムスタンプ付きファイル名
- **出力項目**:
  - 行番号
  - 法人番号
  - 名称（入力）
  - 住所（入力）
  - 照合ステータス
  - 名称（国税庁）
  - 住所（国税庁）

### 5. エラーハンドリング ✅
- **場所**: 
  - フロントエンド: `front/components/FileUploadForm.tsx`
  - バックエンド: `api/app/services/corporate_lookup.py`
- **機能**: 
  - ネットワークエラーの処理
  - APIエラーの詳細ログ出力
  - ユーザーフレンドリーなエラーメッセージ表示

### 6. デバッグ機能 ✅
- **場所**: `api/app/services/corporate_lookup.py`
- **機能**: 
  - リクエストURLのログ出力
  - レスポンスステータスと内容のログ出力
  - 404エラーの詳細分析

## 技術的な実装詳細

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **主要コンポーネント**:
  - `FileUploadForm.tsx`: メインのファイルアップロードと照合機能
  - `Logo.tsx`: ロゴコンポーネント
- **API クライアント**: `front/lib/apiClient.ts`

### バックエンド
- **フレームワーク**: FastAPI
- **言語**: Python 3
- **主要モジュール**:
  - `api/app/routes/checks.py`: API エンドポイント定義
  - `api/app/services/corporate_lookup.py`: 国税庁API連携サービス
  - `api/app/schemas/corporate.py`: データスキーマ定義
  - `api/app/core/config.py`: 設定管理

### 外部API連携
- **API**: 国税庁法人番号 Web-API
- **エンドポイント**: `https://api.houjin-bangou.nta.go.jp/4/num`
- **認証**: アプリケーションID（環境変数 `HOUJIN_APP_ID`）
- **レート制限対策**: リクエスト間隔1秒（デフォルト）

## データフロー

1. **ファイルアップロード**
   ```
   ユーザー → フロントエンド → POST /checks/upload → バックエンド
   → CSVパース → レコード抽出 → JSONレスポンス → フロントエンド表示
   ```

2. **一括照合**
   ```
   フロントエンド → POST /checks/bulk-lookup → バックエンド
   → 各レコードについて:
      → レート制限待機 → 国税庁API呼び出し → 照合ロジック実行
   → 照合結果をまとめて返却 → フロントエンド表示
   ```

3. **CSVダウンロード**
   ```
   フロントエンド（照合結果データ） → CSV生成 → Blob作成 → ダウンロード
   ```

## 環境変数

### 必須
- `HOUJIN_APP_ID`: 国税庁法人番号 Web-API のアプリケーションID

### オプション
- `HOUJIN_API_REQUEST_INTERVAL`: リクエスト間隔（秒、デフォルト: 1.0）
- `HOUJIN_API_MAX_RETRIES`: 最大リトライ回数（デフォルト: 3）
- `HOUJIN_API_RETRY_DELAY`: リトライ時の待機時間（秒、デフォルト: 2.0）

## 未実装機能（将来予定）

1. **フィルタリング機能**
   - 要確認・不一致のみを絞り込み表示
   - 要件定義に記載あり

2. **表記ゆれ対策**
   - 株式会社/(株)などの表記統一
   - 全角・半角の統一
   - コメントに「将来実装予定」と記載

3. **Excelファイル直接対応**
   - 現在はCSVのみ対応
   - .xlsx, .xls の直接アップロード

4. **履歴保存機能**
   - 照合結果のデータベース保存
   - 過去の照合履歴の参照

## テスト状況

- 単体テスト: 未実装
- 統合テスト: 未実装
- 手動テスト: 実施済み（ダミーモードでの動作確認）

## 既知の制限事項

1. **アプリケーションID未設定時の動作**
   - ダミーモードで動作
   - 法人番号 "0000000000000" のみテストデータを返す
   - その他の法人番号は "未登録" として扱われる

2. **CSV形式の制限**
   - カンマや改行を含む値の処理は基本的なエスケープのみ
   - 複雑なCSV形式には対応していない可能性

3. **レート制限**
   - デフォルトで1秒間隔でリクエスト
   - 大量データの処理には時間がかかる

## セキュリティ考慮事項

1. **環境変数の管理**
   - `.env` ファイルは Git に含めない
   - アプリケーションIDは機密情報として扱う

2. **CORS設定**
   - 開発環境: `http://localhost:3000` のみ許可
   - 本番環境では適切に設定が必要

3. **ファイルアップロード**
   - 拡張子チェックのみ実装
   - ファイルサイズ制限は未実装

## パフォーマンス

- **一括照合**: レコード数 × 1秒（レート制限のため）
- **例**: 100件の照合には約100秒かかる
- **改善案**: バッチ処理や並列処理の検討（将来）

## ログ出力

### バックエンドログ
- APIリクエストURL
- レスポンスステータス
- エラー詳細
- 進捗状況（50件ごと）

### フロントエンドログ
- 照合完了サマリー（コンソール）

## 今後の改善案

1. **パフォーマンス向上**
   - バッチ処理の実装
   - 並列処理の検討

2. **ユーザビリティ向上**
   - 進捗バーの表示
   - キャンセル機能

3. **機能拡張**
   - フィルタリング機能
   - ソート機能
   - 検索機能

4. **テスト実装**
   - 単体テスト
   - 統合テスト
   - E2Eテスト
