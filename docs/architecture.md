# Houjin Align アーキテクチャ概要

このドキュメントは、Houjin Align のシステムアーキテクチャの概要を説明します。

## 1. システム全体像

Houjin Align は、外部パートナーから受領した法人情報リスト（CSV/Excel）と、国税庁法人番号 Web-API から取得した正式な法人情報を照合し、整合性をチェックするツールです。ユーザーがアップロードしたデータを自動で照合し、一致・不一致・要確認の判定結果を一覧表示や CSV ダウンロードで提供します。

## 2. 構成コンポーネント

### フロントエンド（Next.js）

- ユーザーがファイル（CSV/Excel）をアップロードするための UI を提供
- バックエンド API から取得した照合結果を一覧表示
- フィルタリング機能（一致・不一致・要確認の絞り込み）
- 照合結果を CSV 形式でダウンロードする機能

### バックエンド API（FastAPI）

- アップロードされたファイルを受け取り、パース処理を実行
- 各レコードについて国税庁法人番号 Web-API を呼び出して正式情報を取得
- 元データと正式情報を照合し、一致・不一致・要確認の判定を行う
- 照合結果をフロントエンドに返す

### 外部サービス（国税庁 法人番号 Web-API）

- 法人番号をキーとして、正式な法人情報（社名・所在地など）を提供する公的 API
- 本ツールはこの API を利用して、アップロードされたデータの正確性を検証する

### ストレージやログ

- 初期バージョンでは、照合結果の恒久保存は行わない（一時的なチェックツールとして設計）
- 処理ログやエラーログは、運用・保守のために記録する
- 将来的に履歴保存が必要になった場合は、データベースやストレージを追加する

## 3. ディレクトリ構成（案）

```
houjin-align/
├── api/              # FastAPI アプリケーション
│   ├── app/
│   │   ├── main.py   # FastAPI のエントリーポイント
│   │   ├── routes/   # API エンドポイント定義
│   │   ├── services/ # ビジネスロジック（照合処理など）
│   │   └── utils/    # ユーティリティ関数
│   ├── requirements.txt
│   └── .env.example  # 環境変数のテンプレート
│
├── front/            # Next.js フロントエンド
│   ├── app/          # Next.js App Router のページ
│   ├── components/   # React コンポーネント
│   ├── lib/          # フロントエンド用ユーティリティ
│   └── package.json
│
└── docs/             # 要件定義・設計ドキュメント
    ├── requirements.md
    └── architecture.md
```

## 4. 基本データフロー（MVP）

1. **ファイルアップロード**: ユーザーがブラウザから CSV または Excel ファイルをアップロードする
2. **ファイル受信・パース**: フロントエンドから FastAPI にファイルが送信され、バックエンドでファイル内容をパースしてレコード単位に分割する
3. **法人番号 API 照会**: 各レコードの法人番号をキーとして、国税庁法人番号 Web-API に順次リクエストを送信し、正式な法人情報を取得する
4. **照合ロジック実行**: 取得した正式情報と、アップロードされた元データ（社名・所在地など）を比較し、「一致」「要確認」「不一致」のいずれかに判定する
5. **結果返却**: 照合結果をフロントエンドに返す
6. **結果表示**: フロントエンドで照合結果を一覧表示し、ユーザーが確認できるようにする
7. **CSV ダウンロード**: ユーザーが必要に応じて、照合結果を CSV ファイルとしてダウンロードできる

## 5. 今後の拡張を見据えたポイント

### 疎結合な設計

フロントエンドとバックエンドは RESTful API を通じて通信し、それぞれが独立して開発・デプロイできるように設計します。これにより、将来的に履歴保存機能やバッチ処理機能、Slack 通知機能などを追加する際も、既存のコードへの影響を最小限に抑えられます。

### 外部 API 呼び出しのモジュール化

国税庁法人番号 Web-API を呼び出す処理は、専用のサービスモジュール（例：`api/app/services/nta_api_client.py`）に切り出します。これにより、API の仕様変更や、レート制限対策、リトライロジックの追加などが容易になります。また、テスト時にはこのモジュールをモック化することで、外部 API に依存しない単体テストを実現できます。

